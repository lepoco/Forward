"use strict";import Forward from"../common/core.min.js";export const name="forward-dashboard";export default function(){Forward.console("[Module] Dashboard imported")}let current_record={id:null,url:null,target:null,name:null,display_name:null},clipboard_link=new ClipboardJS(".dashboard__btn--copy-recent");function appendRecordToList(r,e,a,t){jQuery(".records-list__container").prepend('<div class="records-list__record record-'+r+'" data-clipboard-text="'+forward.baseurl+e+'" data-id="'+r+'"><p>/'+e+"</p><span>"+a+"</span><h4>"+t+"</h4></div>")}let record_keys=Object.keys(records);for(let r=0;r<record_keys.length;r++)appendRecordToList(records[record_keys[r]][0],records[record_keys[r]][4],records[record_keys[r]][5],records[record_keys[r]][1]),r==record_keys.length-1&&updateRecordData(records[record_keys[r]][0]);clipboard_link.destroy(),clipboard_link=new ClipboardJS(".dashboard__btn--copy-recent"),clipboard_link.on("success",function(r){Forward.toast(Forward.__("success"),"The link has been copied to your clipboard!",3e3,"success")}),jQuery(".forward-dashboard__add__form").on("submit",function(r){r.preventDefault(),Forward.console("New record via Standard Add");let e=jQuery("#input-dashboard-record-url").val();Forward.ajax(jQuery(".forward-dashboard__add__form").serialize(),function(r){if("s01"==r){let r=jQuery("#input-dashboard-record-slug").val();""==r&&(r=jQuery("#input-dashboard-rand-value").val()),forward.baseurl,jQuery("#input-record-url").val();let a=new Date;a=a.getFullYear()+"-"+("0"+(a.getMonth()+1)).slice(-2)+"-"+("0"+a.getDate()).slice(-2),appendRecordToList(-1,r,e,0),Forward.toast(Forward.__("success"),"New record has been added",6e3,"success")}else{let e=Forward.__("e1");"e07"==r?e=Forward.__("e7"):"e08"==r?e=Forward.__("e8"):"e10"==r&&(e=Forward.__("e10")),Forward.toast(Forward.__("error"),e,6e3,"alert")}console.log(r)})});let chartColors=["#696ffb","#7db8f9","#05478f","#00cccc","#6CA5E0","#1A76CA"],chartGridLineColor="#383e5d",chartFontcolor="#b9c0d3",ds_chart_days=null,ds_chart_origins=null,ds_chart_languages=null,ds_chart_platforms=null,ds_chart_agents=null,recentDaysList=[];for(let r=0;30>r;r++){let e=new Date;e.setDate(e.getDate()-r),recentDaysList.push(("0"+e.getDate()).slice(-2)+" "+forward.months_short[e.getMonth()])}function updateRecordCharts(r,e,a,t,d){if(null!=r&&null!=ds_chart_days){let e=Object.keys(r),a=[],t=null;for(let r=0;r<e.length;r++)t=e[r].split("-"),a.push(t[0]+" "+forward.months_short[parseInt(t[1])-1]);let d=[];for(let a=0;a<e.length;a++)d.push(r[e[a]]);ds_chart_days.data.labels=a,ds_chart_days.data.datasets[0].data=d,ds_chart_days.update()}if(null!=e&&null!=ds_chart_origins){if(1>e.length)ds_chart_origins.data.labels=[Forward.__("nodata")],ds_chart_origins.data.datasets[0].data=[1];else{let r=Object.keys(e),a=[];for(let t=0;t<r.length;t++)a.push(e[r[t]]);let t=[];for(let e=0;e<r.length;e++)t.push(Forward.__(forward.visitors.origins[r[e]]));ds_chart_origins.data.labels=t,ds_chart_origins.data.datasets[0].data=a}ds_chart_origins.data.datasets[0].backgroundColor=Forward.shuffle(chartColors),ds_chart_origins.update()}if(null!=a&&null!=ds_chart_languages){if(1>a.length)ds_chart_languages.data.labels=[Forward.__("nodata")],ds_chart_languages.data.datasets[0].data=[1];else{let r=Object.keys(a),e=[];for(let t=0;t<r.length;t++)e.push(a[r[t]]);let t=[];for(let e=0;e<r.length;e++)t.push(Forward.__(forward.visitors.languages[r[e]]));ds_chart_languages.data.labels=t,ds_chart_languages.data.datasets[0].data=e}ds_chart_languages.update()}if(null!=t&&null!=ds_chart_platforms){if(1>t.length)ds_chart_platforms.data.labels=[Forward.__("nodata")],ds_chart_platforms.data.datasets[0].data=[1];else{let r=Object.keys(t),e=[];for(let a=0;a<r.length;a++)e.push(t[r[a]]);let a=[];for(let e=0;e<r.length;e++)a.push(Forward.__(forward.visitors.platforms[r[e]]));ds_chart_platforms.data.labels=a,ds_chart_platforms.data.datasets[0].data=e}ds_chart_platforms.update()}if(null!=d&&null!=ds_chart_agents){if(1>d.length)ds_chart_agents.data.labels=[Forward.__("nodata")],ds_chart_agents.data.datasets[0].data=[1];else{let r=Object.keys(d),e=[];for(let a=0;a<r.length;a++)e.push(d[r[a]]);let a=[];for(let e=0;e<r.length;e++)a.push(Forward.__(forward.visitors.agents[r[e]]));ds_chart_agents.data.labels=a,ds_chart_agents.data.datasets[0].data=e}ds_chart_agents.update()}}function updateRecordData(r){Forward.ajax({action:"get_record_data",nonce:forward.getrecord,input_record_id:r},function(r){if(Forward.isJson(r)){let e=JSON.parse(r);current_record.id=e.record_id,current_record.url=forward.baseurl+e.record_name,current_record.target=e.record_url,current_record.name=e.record_name,current_record.display_name=e.record_display_name,updateRecordCharts(e.visitors.days,e.visitors.origins,e.visitors.languages,e.visitors.platforms,e.visitors.agents),jQuery("#ds_record_name").html("/"+e.record_display_name),jQuery("#ds_record_url").html(e.record_url),jQuery("#ds_record_clicks").html(e.record_clicks),jQuery("#ds_archive_name").html("/"+e.record_display_name),jQuery("#ds_archive_target").html(e.record_url),jQuery("#ds_archive_clicks").html(e.record_clicks),jQuery("#ds_archive_action").attr("data-id",e.record_id),jQuery("#ds_record_copy").attr("data-clipboard-text",forward.baseurl+e.record_name),clipboard_link.destroy(),clipboard_link=new ClipboardJS(".dashboard__btn--copy-recent"),clipboard_link.on("success",function(r){Forward.toast(Forward.__("success"),"The link has been copied to your clipboard!",3e3,"success")})}else Forward.toast(Forward.__("error"),"Something went wrong...",6e3,"alert")})}jQuery("#ds_chart_days").length&&(ds_chart_days=new Chart(document.getElementById("ds_chart_days").getContext("2d"),{type:"bar",data:{labels:recentDaysList.reverse(),datasets:[{label:"# "+Forward.__("of clicks"),data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],backgroundColor:Forward.shuffle(chartColors),borderColor:"transparent"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{display:!0,ticks:{autoSkip:!0,maxTicksLimit:5}},y:{display:!1,min:0}}}})),jQuery("#ds_chart_origins").length&&(ds_chart_origins=new Chart(document.getElementById("ds_chart_origins").getContext("2d"),{type:"doughnut",data:{labels:[Forward.__("unknown")],datasets:[{data:[1],backgroundColor:Forward.shuffle(chartColors),borderColor:"transparent",borderWidth:1}]},options:{fill:!0,responsive:!0,maintainAspectRatio:!0,tension:.4,plugins:{legend:{display:!1}}}})),jQuery("#ds_chart_languages").length&&(ds_chart_languages=new Chart(document.getElementById("ds_chart_languages").getContext("2d"),{type:"doughnut",data:{labels:[Forward.__("unknown")],datasets:[{data:[1],backgroundColor:Forward.shuffle(chartColors),borderColor:"transparent",borderWidth:1}]},options:{fill:!0,responsive:!0,hover:{mode:"nearest",intersect:!0},tooltips:{mode:"label",position:"nearest",intersect:!0},maintainAspectRatio:!0,tension:.4,plugins:{legend:{display:!1}}}})),jQuery("#ds_chart_platforms").length&&(ds_chart_platforms=new Chart(document.getElementById("ds_chart_platforms").getContext("2d"),{type:"doughnut",data:{labels:[Forward.__("unknown")],datasets:[{data:[1],backgroundColor:Forward.shuffle(chartColors),borderColor:"transparent",borderWidth:1}]},options:{fill:!0,responsive:!0,maintainAspectRatio:!0,tension:.4,plugins:{legend:{display:!1}}}})),jQuery("#ds_chart_agents").length&&(ds_chart_agents=new Chart(document.getElementById("ds_chart_agents").getContext("2d"),{type:"doughnut",data:{labels:[Forward.__("unknown")],datasets:[{data:[1],backgroundColor:Forward.shuffle(chartColors),borderColor:"transparent",borderWidth:1}]},options:{fill:!0,responsive:!0,maintainAspectRatio:!0,tension:.4,plugins:{legend:{display:!1}}}})),jQuery(".records-list__record").on("click",function(r){r.preventDefault();let e=jQuery(this).data();1>e.id||updateRecordData(e.id)}),jQuery("#ds_archive_action").on("click",function(r){r.preventDefault(),console.log(jQuery(this).data()),console.log("ARCHIVE RECORD");let e=bootstrap.Modal.getInstance(document.getElementById("archiveRecordModal"));e.hide(),Forward.toast(Forward.__("success"),"The link has been archived",6e3,"success")}),jQuery("#ds_record_qrcode").on("click",function(r){let e=new bootstrap.Modal(document.getElementById("qrcodeRecordModal"),{keyboard:!1}),a="#000000ff";jQuery(".forward-app").hasClass("dark-theme")&&(a="#ffffffff"),jQuery("#ds_qrcode_download").attr("download","forward_qrcode_"+current_record.display_name+".png"),QRCode.toDataURL(document.getElementById("ds_qrcode_canvas"),current_record.url,{errorCorrectionLevel:"H",type:"image/png",quality:1,margin:0,scale:10,color:{dark:a,light:"#00000000"}},function(r,a){if(r)return e.hide(),void Forward.toast(Forward.__("error"),r,6e3,"alert");jQuery("#ds_qrcode_download").attr("href",a)}),e.show()});